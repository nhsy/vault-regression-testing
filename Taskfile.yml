version: '3'

dotenv: ['.env']

vars:
  INIT_FILE: .vault_init.json
  PROJECT_NAME: '{{.COMPOSE_PROJECT_NAME | default "vault-regression-testing"}}'
  VAULT_CONTAINER: '{{.COMPOSE_PROJECT_NAME | default "vault-regression-testing"}}_vault'
  LDAP_CONTAINER: '{{.COMPOSE_PROJECT_NAME | default "vault-regression-testing"}}_ldap'
  POSTGRES_CONTAINER: '{{.COMPOSE_PROJECT_NAME | default "vault-regression-testing"}}_postgres'

tasks:
  prereqs:
    desc: Check if all prerequisites are installed
    cmds:
      - which docker
      - which terraform
      - which jq
      - which python3
      - which curl
      - echo "All prerequisites are installed."
    silent: true

  setup:
    desc: Create virtual environment, install dependencies, and create .env
    cmds:
      - test -f .env || cp .env.example .env
      - python3 -m venv .venv
      - ./.venv/bin/pip install -r requirements.txt
    silent: true

  up:
    desc: Start Vault and LDAP containers and wait for readiness
    cmds:
      - docker compose up -d
      - |
        . .env
        echo "Waiting for Vault to be ready..."
        for i in $(seq 1 30); do
          if curl -s -o /dev/null $VAULT_ADDR/v1/sys/health; then
            echo "Vault API is responding"
            break
          fi
          sleep 1
        done
        echo "Waiting for LDAP to be ready..."
        for i in $(seq 1 30); do
          if docker exec {{.LDAP_CONTAINER}} ldapsearch -x -b "dc=example,dc=org" -D "cn=admin,dc=example,dc=org" -w adminpassword > /dev/null 2>&1; then
            echo "LDAP is responding"
            exit 0
          fi
          sleep 1
        done
        echo "Timeout waiting for services"
        exit 1
    silent: true

  down:
    desc: Stop containers and remove volumes
    cmds:
      - docker compose rm -vfs

  init:
    desc: Initialize both LDAP and Vault
    cmds:
      - test -f .env || cp .env.example .env
      - task: ldap:init
      - task: vault:init
      - task: vault:unseal
    silent: true

  ldap:init:
    desc: Initialize LDAP with sample data
    cmds:
      - docker exec {{.LDAP_CONTAINER}} ldapadd -x -D "cn=admin,dc=example,dc=org" -w adminpassword -f /ldap-example.ldif -c || true

  ldap:status:
    desc: Check LDAP status and list users
    cmds:
      - docker exec {{.LDAP_CONTAINER}} ldapsearch -x -D "cn=admin,dc=example,dc=org" -w adminpassword -b "ou=People,dc=example,dc=org" "(objectClass=inetOrgPerson)" dn

  postgres:status:
    desc: Check PostgreSQL status and list databases
    cmds:
      - docker exec {{.POSTGRES_CONTAINER}} psql -U vaultadmin -d vaultdb -c '\l'
      - docker exec {{.POSTGRES_CONTAINER}} psql -U vaultadmin -d vaultdb -c '\du'

  postgres:test-readonly:
    desc: Test Vault dynamic readonly credentials for PostgreSQL
    cmds:
      - |
        source .env
        echo "Generating readonly credentials from Vault..."
        CREDS=$(vault read -format=json database/creds/readonly)
        USERNAME=$(echo $CREDS | jq -r '.data.username')
        PASSWORD=$(echo $CREDS | jq -r '.data.password')
        LEASE_ID=$(echo $CREDS | jq -r '.lease_id')
        echo "Username: $USERNAME"
        echo "Lease ID: $LEASE_ID"
        echo ""
        echo "Testing database connection with readonly credentials..."
        docker exec {{.POSTGRES_CONTAINER}} psql -U $USERNAME -d vaultdb -c 'SELECT COUNT(*) FROM test_data;' || echo "Failed to connect"
        echo ""
        echo "Testing write permissions (should fail)..."
        docker exec {{.POSTGRES_CONTAINER}} psql -U $USERNAME -d vaultdb -c 'CREATE TABLE test_table (id INT);' && echo "ERROR: Should not have write access!" || echo "Correctly denied write access"
        echo ""
        echo "Revoking lease..."
        vault lease revoke $LEASE_ID
        echo "Lease revoked successfully"

  postgres:test-readwrite:
    desc: Test Vault dynamic readwrite credentials for PostgreSQL
    cmds:
      - |
        source .env
        echo "Generating readwrite credentials from Vault..."
        CREDS=$(vault read -format=json database/creds/readwrite)
        USERNAME=$(echo $CREDS | jq -r '.data.username')
        PASSWORD=$(echo $CREDS | jq -r '.data.password')
        LEASE_ID=$(echo $CREDS | jq -r '.lease_id')
        echo "Username: $USERNAME"
        echo "Lease ID: $LEASE_ID"
        echo ""
        echo "Testing database connection with readwrite credentials..."
        docker exec {{.POSTGRES_CONTAINER}} psql -U $USERNAME -d vaultdb -c 'SELECT COUNT(*) FROM test_data;' || echo "Failed to connect"
        echo ""
        echo "Testing write permissions..."
        docker exec {{.POSTGRES_CONTAINER}} psql -U $USERNAME -d vaultdb -c 'CREATE TABLE temp_test (id INT); INSERT INTO temp_test VALUES (1); DROP TABLE temp_test;' && echo "Write access confirmed" || echo "ERROR: Should have write access!"
        echo ""
        echo "Revoking lease..."
        vault lease revoke $LEASE_ID
        echo "Lease revoked successfully"

  postgres:test:
    desc: Test both readonly and readwrite dynamic credentials
    cmds:
      - task: postgres:test-readonly
      - echo ""
      - echo "================================"
      - echo ""
      - task: postgres:test-readwrite

  vault:init:
    desc: Initialize Vault and update .env
    interactive: true
    cmds:
      - |
        . .env
        if [ -f {{.INIT_FILE}} ]; then
          printf "Vault init file already exists. Overwrite? (y/N): "
          read yn
          if [ "$yn" != "y" ] && [ "$yn" != "Y" ]; then
            echo "Initialization skipped."
            exit 0
          fi
        fi
        docker exec -e VAULT_ADDR=$VAULT_ADDR {{.VAULT_CONTAINER}} vault operator init -format=json > {{.INIT_FILE}}
        if [ -s {{.INIT_FILE}} ]; then
          ROOT_TOKEN=$(jq -r '.root_token' {{.INIT_FILE}})
          sed -i.bak "s/export VAULT_TOKEN=.*/export VAULT_TOKEN=$ROOT_TOKEN/" .env && rm .env.bak
          echo "Vault initialized. Root token updated in .env"
        else
          echo "Failed to initialize Vault or empty output."
          exit 1
        fi

  vault:unseal:
    desc: Unseal Vault
    cmds:
      - |
        . .env
        if [ -f {{.INIT_FILE}} ]; then
          KEYS=$(jq -r '.unseal_keys_b64[]' {{.INIT_FILE}})
          for key in $KEYS; do
            docker exec -e VAULT_ADDR=$VAULT_ADDR {{.VAULT_CONTAINER}} vault operator unseal $key
          done
        else
          echo "Init file missing. Cannot unseal."
          exit 1
        fi

  vault:status:
    desc: Check Vault status
    cmds:
      - |
        source .env
        vault status

  terraform:apply:
    aliases: [apply]
    desc: Initialize and apply Terraform configuration
    dir: terraform
    cmds:
      - terraform init
      - source ./../.env && terraform apply -auto-approve
      - sleep 10

  terraform:destroy:
    desc: Destroy Terraform resources
    dir: terraform
    cmds:
      - source .env && terraform destroy -auto-approve -lock=false

  test:
    desc: Run pytest suite
    cmds:
      - mkdir -p outputs
      - source .env && ./.venv/bin/python3 -m pytest --cov=tests --cov-report=term-missing --cov-report=xml:outputs/coverage.xml --cov-report=html:outputs/coverage_html --junitxml=outputs/report.xml --html=outputs/report.html --self-contained-html

  lint:
    desc: Run Python linting (flake8, black) and Terraform formatting
    cmds:
      - ./.venv/bin/python3 -m flake8 tests
      - ./.venv/bin/python3 -m black --check tests
      - terraform fmt -check -recursive

  clean:
    desc: Cleanup all temporary files, virtual environments, and Docker resources
    cmds:
      - task: down
      - sleep 5
      - rm -rf {{.INIT_FILE}} terraform/.terraform terraform/terraform.tfstate terraform/terraform.tfstate.backup .pytest_cache outputs
      - |
        VOLUMES=$(docker volume ls -q -f name={{.PROJECT_NAME}})
        if [ ! -z "$VOLUMES" ]; then
          docker volume rm $VOLUMES 2>/dev/null || true
        fi

  vault:upgrade:
    aliases: [upgrade]
    desc: Upgrade Vault version and run tests
    cmds:
      - |
        source .env
        VAULT_VERSION=$VAULT_VERSION_UPGRADE docker compose up -d --force-recreate
        VAULT_VERSION=$VAULT_VERSION_UPGRADE task up
      - task: vault:unseal
      - task: vault:status
      - sleep 10
      - task: test

  all:
    desc: Run everything
    cmds:
      - task: prereqs
      - task: lint
      - task: up
      - task: init
      - task: apply
      - task: test
